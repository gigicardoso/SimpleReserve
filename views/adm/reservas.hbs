<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
<div class="container">
	<div class="header" style="margin-bottom: 30px;">
	  <div class="title-container" style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
			<h1 style="margin: 0;"><i class="bi bi-calendar-check"></i> Gerenciador de Reservas</h1>
			<!-- Bootstrap Icons for the PDF icon -->
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
				<button id="btnEmitirHistorico" onclick="exportarHistoricoPDF()" style="font-size: 16px; padding: 8px 18px; border-radius: 8px; display: flex; align-items: center; gap: 8px; background: #84925b; color: #fff; border: none; font-weight: 600; cursor: pointer;">
					<i class="bi bi-file-earmark-pdf"></i> Emitir Relatório em PDF
				</button>
			</div>

			<!-- Filters (copied markup/classes from /pesquisar to match exact style) -->
			<div class="search-container" style="display: flex; flex-wrap: nowrap; gap: 12px; align-items: center;">
				<select id="filter-user" class="filter-select">
					<option value="">Todos os usuários</option>
					{{#each usuarios}}
						<option value="{{this}}">{{this}}</option>
					{{/each}}
				</select>
				<select id="filter-sala" class="filter-select">
					<option value="">Todas as salas</option>
					{{#each salas}}
						<option value="{{this}}">{{this}}</option>
					{{/each}}
				</select>
				<input id="filter-date" type="date" class="filter-select" />
				<input id="filter-start" type="time" class="filter-select" />
				<input id="filter-end" type="time" class="filter-select" />
			</div>
				</div>
	</div>
	<div class="user-table-container" style="margin-left: 140px; margin-right: 50px;">
		<table class="user-table">
			<thead>
				<tr>
					<th>Usuário</th>
					<th>Sala</th>
					<th>Data</th>
					<th>Horário</th>
					<th>Ações</th>
				</tr>
			</thead>
			<tbody>
	{{#each reservas}}
			<tr data-user="{{this.nomeUsuario}}" data-sala="{{this.nomeSala}}" data-date="{{this.dataReserva}}" data-start="{{this.horaInicio}}" data-end="{{this.horaFim}}">
				<td>{{this.nomeUsuario}}</td>
				<td>{{this.nomeSala}}</td>
				<td>{{formatarData this.dataReserva}}</td>
				<td>{{this.horaInicio}} - {{this.horaFim}}</td>
			<td>
				<div class="actions-flex" style="width: 100%; justify-content: center;">
					<div class="actions" style="display: flex; gap: 8px; justify-content: flex-end;">
						{{#if ../podeEditarReserva}}
						<a href="/reservas/editar/{{this.id_agenda}}?origem=reservasadm" class="btn-action btn-edit">
							<i class="fas fa-edit"></i>
							<span class="btn-text">Editar</span>
						</a>
						{{/if}}
						{{#if ../podeExcluirReserva}}
						<button type="submit" form="form-excluir-{{this.id_agenda}}" class="btn-action btn-delete" onclick="return confirm('Deseja apagar esta reserva?')">
							<i class="fas fa-trash-alt"></i>
							<span class="btn-text">Excluir</span>
						</button>
						<form id="form-excluir-{{this.id_agenda}}" action="/reservas/excluir/{{this.id_agenda}}" method="GET" style="display:none;">
							<input type="hidden" name="origem" value="reservasadm" />
						</form>
						{{/if}}
					</div>
				</div>
			</td>
		</tr>
  {{else}}
	<tr><td colspan="5">Nenhuma reserva encontrada.</td></tr>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
 
  {{/each}}
</tbody>
		</table>
		 <!-- Tabela oculta para exportação PDF (sem coluna de ações) -->
		 <table id="tabelaHistoricoPDF" style="display:none;">
			 <thead>
				 <tr>
					 <th>Usuário</th>
					 <th>Sala</th>
					 <th>Data</th>
					 <th>Horário</th>
				 </tr>
			 </thead>
			 <tbody>
				 {{#each reservas}}
				 <tr>
					 <td>{{this.nomeUsuario}}</td>
					 <td>{{this.nomeSala}}</td>
					 <td>{{formatarData this.dataReserva}}</td>
					 <td>{{this.horaInicio}} - {{this.horaFim}}</td>
				 </tr>
				 {{else}}
				 <tr><td colspan="4">Nenhuma reserva encontrada.</td></tr>
				 {{/each}}
			 </tbody>
		 </table>
	</div>
</div>

<link rel="stylesheet" href="/stylesheets/usuariosAdm.css">
<link rel="stylesheet" href="/stylesheets/pesquisarSalas.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<style>
.user-table th {
	font-family: 'Poppins', sans-serif !important;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script>
// Utility to parse HH:MM into minutes
function timeToMinutes(t) {
	if (!t) return null;
	const parts = t.split(':');
	if (parts.length < 2) return null;
	return parseInt(parts[0], 10) * 60 + parseInt(parts[1], 10);
}

function applyFilters() {
	const userSel = document.getElementById('filter-user');
	const salaSel = document.getElementById('filter-sala');
	const dateInput = document.getElementById('filter-date');
	const startInput = document.getElementById('filter-start');
	const endInput = document.getElementById('filter-end');

	const u = (userSel && userSel.value) || '';
	const s = (salaSel && salaSel.value) || '';
	const d = (dateInput && dateInput.value) || '';
	const startFilter = (startInput && startInput.value) || '';
	const endFilter = (endInput && endInput.value) || '';

	console.log('=== Filtros aplicados ===');
	console.log('Horário Início:', startFilter);
	console.log('Horário Fim:', endFilter);

	const rows = document.querySelectorAll('.user-table tbody tr');
	rows.forEach(r => {
		// Skip rows that are not data rows
		const rowUser = (r.getAttribute('data-user') || '').toLowerCase();
		const rowSala = (r.getAttribute('data-sala') || '').toLowerCase();
		const rowDate = r.getAttribute('data-date') || '';
		const rowStart = r.getAttribute('data-start') || '';
		const rowEnd = r.getAttribute('data-end') || '';

		console.log('Linha:', {
			user: rowUser,
			sala: rowSala,
			date: rowDate,
			start: rowStart,
			end: rowEnd
		});

		let show = true;
		if (u && rowUser.indexOf(u.toLowerCase()) === -1) show = false;
		if (s && rowSala.indexOf(s.toLowerCase()) === -1) show = false;
		if (d && rowDate !== d) show = false;

		// Time filter: exact match, not overlap
		const rowStartMin = timeToMinutes(rowStart);
		const rowEndMin = timeToMinutes(rowEnd);
		const filterStartMin = timeToMinutes(startFilter);
		const filterEndMin = timeToMinutes(endFilter);

		console.log('Conversão minutos:', {
			rowStart: rowStartMin,
			rowEnd: rowEndMin,
			filterStart: filterStartMin,
			filterEnd: filterEndMin
		});

		// If startFilter is set, reservation must START at or after the filter start time
		if (filterStartMin !== null && rowStartMin !== null && rowStartMin < filterStartMin) {
			console.log('❌ Escondendo: reserva começa antes do horário inicial filtrado');
			show = false;
		}
		// If endFilter is set, reservation must END at or before the filter end time
		if (filterEndMin !== null && rowEndMin !== null && rowEndMin > filterEndMin) {
			console.log('❌ Escondendo: reserva termina depois do horário final filtrado');
			show = false;
		}

		console.log('Mostrar linha?', show);
		console.log('---');

		r.style.display = show ? '' : 'none';
	});
}

document.addEventListener('DOMContentLoaded', function() {
	const userSel = document.getElementById('filter-user');
	const salaSel = document.getElementById('filter-sala');
	const dateInput = document.getElementById('filter-date'); 
	const startInput = document.getElementById('filter-start');
	const endInput = document.getElementById('filter-end');

	if (userSel) userSel.addEventListener('change', applyFilters);
	if (salaSel) salaSel.addEventListener('change', applyFilters);
	if (dateInput) dateInput.addEventListener('change', applyFilters);
	if (startInput) startInput.addEventListener('change', applyFilters);
	if (endInput) endInput.addEventListener('change', applyFilters);
});

function exportarHistoricoPDF() {
	if (typeof jspdf === 'undefined' || typeof window.jspdf === 'undefined') {
		alert('Erro: Biblioteca jsPDF não carregada!');
		return;
	}
	const { jsPDF } = window.jspdf;
	const doc = new jsPDF();
	doc.setFontSize(16);
	doc.text('Histórico de Reservas', 105, 15, { align: 'center' });

	const rows = Array.from(document.querySelectorAll('.user-table tbody tr'))
		.filter(r => r.style.display !== 'none')
		.map(r => {
			const cols = r.querySelectorAll('td');
			return [
				cols[0] ? cols[0].innerText.trim() : '',
				cols[1] ? cols[1].innerText.trim() : '',
				cols[2] ? cols[2].innerText.trim() : '',
				cols[3] ? cols[3].innerText.trim() : ''
			];
		});

	const head = [['Usuário', 'Sala', 'Data', 'Horário']];

	doc.autoTable({
		head: head,
		body: rows,
		startY: 25,
		styles: { fontSize: 10, cellPadding: 3 },
		headStyles: { fillColor: [76, 175, 80], textColor: 255, fontStyle: 'bold' },
		alternateRowStyles: { fillColor: [245, 245, 245] }
	});

	doc.save('historico.pdf');
}
</script>
